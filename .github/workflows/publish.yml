name: Publish Release

on:
    # Manual trigger to publish
    workflow_dispatch:

    # Auto-trigger when release PR is merged
    pull_request:
        types:
            - closed
        branches:
            - main

jobs:
    publish:
        # Only run if PR was merged (not just closed) OR manual trigger
        if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release'))
        runs-on: windows-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Get version from package.json
              id: package-version
              run: |
                  $version = (Get-Content package.json | ConvertFrom-Json).version
                  echo "VERSION=$version" >> $env:GITHUB_OUTPUT
                  echo "Building and releasing version: $version"

            - name: Check if release exists
              id: check-release
              run: |
                  $version = "${{ steps.package-version.outputs.VERSION }}"
                  $tag = "v$version"
                  try {
                    $releases = gh release list --limit 100
                    if ($releases -match $tag) {
                      echo "RELEASE_EXISTS=true" >> $env:GITHUB_OUTPUT
                      echo "Release $tag already exists, skipping publish"
                    } else {
                      echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
                      echo "Release $tag does not exist, will publish"
                    }
                  } catch {
                    echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
                  }
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}

            - name: Build and Publish
              if: steps.check-release.outputs.RELEASE_EXISTS == 'false'
              run: npm run publish
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}

            - name: Release Summary
              if: steps.check-release.outputs.RELEASE_EXISTS == 'false'
              run: |
                  echo "‚úÖ Successfully released v${{ steps.package-version.outputs.VERSION }}"
                  echo "üì¶ Installers uploaded to GitHub Releases"

            - name: Skip Summary
              if: steps.check-release.outputs.RELEASE_EXISTS == 'true'
              run: |
                  echo "‚è≠Ô∏è Skipped - Release v${{ steps.package-version.outputs.VERSION }} already exists"
