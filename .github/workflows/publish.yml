name: Publish Release

on:
    # Manual trigger to publish
    workflow_dispatch:

    # Auto-trigger when release PR is merged
    pull_request:
        types:
            - closed
        branches:
            - main

jobs:
    publish:
        # Only run if PR was merged (not just closed) OR manual trigger
        if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release'))
        runs-on: windows-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Get version from package.json
              id: package-version
              run: |
                  $version = (Get-Content package.json | ConvertFrom-Json).version
                  echo "VERSION=$version" >> $env:GITHUB_OUTPUT
                  echo "Building and releasing version: $version"

            - name: Check if release exists
              id: check-release
              run: |
                  $version = "${{ steps.package-version.outputs.VERSION }}"
                  $tag = "v$version"
                  try {
                    $releases = gh release list --limit 100
                    if ($releases -match $tag) {
                      echo "RELEASE_EXISTS=true" >> $env:GITHUB_OUTPUT
                      echo "Release $tag already exists, skipping publish"
                    } else {
                      echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
                      echo "Release $tag does not exist, will publish"
                    }
                  } catch {
                    echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
                  }
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}

            - name: Build and Publish
              if: steps.check-release.outputs.RELEASE_EXISTS == 'false'
              run: npm run publish
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}

            - name: Update release with changelog
              if: steps.check-release.outputs.RELEASE_EXISTS == 'false'
              shell: pwsh
              run: |
                  $ErrorActionPreference = "Continue"
                  $version = "${{ steps.package-version.outputs.VERSION }}"
                  $tag = "v$version"
                  
                  # Wait for the release to be fully created by electron-builder
                  Start-Sleep -Seconds 10
                  
                  # Read changelog and extract this version's notes
                  $content = Get-Content CHANGELOG.md -Raw
                  $pattern = "(?s)## \[$version\].*?(?=## \[|$)"
                  $match = [regex]::Match($content, $pattern)
                  
                  if ($match.Success) {
                    $notes = $match.Value.Trim()
                    $tempFile = New-TemporaryFile
                    $notes | Out-File -FilePath $tempFile.FullName -Encoding utf8
                    
                    # Retry up to 3 times in case release is still being created
                    $retries = 0
                    $success = $false
                    while ($retries -lt 3 -and -not $success) {
                      $result = gh release edit $tag --notes-file $tempFile.FullName 2>&1
                      if ($LASTEXITCODE -eq 0) {
                        $success = $true
                        echo "Updated release $tag with changelog"
                      } else {
                        $retries++
                        echo "Retry $retries/3 - waiting for release to be available..."
                        Start-Sleep -Seconds 10
                      }
                    }
                    
                    Remove-Item $tempFile.FullName
                    
                    if (-not $success) {
                      echo "Warning: Could not update release notes after 3 attempts"
                    }
                  } else {
                    echo "No changelog found for version $version"
                  }
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}

            - name: Release Summary
              if: steps.check-release.outputs.RELEASE_EXISTS == 'false'
              run: |
                  echo "Successfully released v${{ steps.package-version.outputs.VERSION }}"
                  echo "Release notes added from CHANGELOG.md"

            - name: Skip Summary
              if: steps.check-release.outputs.RELEASE_EXISTS == 'true'
              run: |
                  echo "⏭️ Skipped - Release v${{ steps.package-version.outputs.VERSION }} already exists"
