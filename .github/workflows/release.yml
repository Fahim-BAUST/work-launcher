name: Build and Release

on:
    # Manual trigger with version bump type
    workflow_dispatch:
        inputs:
            bump_type:
                description: "Version bump type"
                required: true
                default: "patch"
                type: choice
                options:
                    - patch
                    - minor
                    - major

jobs:
    # Job 1: Bump version and create PR
    bump-version:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GH_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Get current version
              id: current-version
              run: |
                  CURRENT_VERSION=$(node -p "require('./package.json').version")
                  echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT
                  echo "Current version: $CURRENT_VERSION"

            - name: Calculate new version
              id: new-version
              run: |
                  CURRENT_VERSION="${{ steps.current-version.outputs.CURRENT_VERSION }}"
                  BUMP_TYPE="${{ github.event.inputs.bump_type }}"

                  IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

                  case $BUMP_TYPE in
                    major)
                      MAJOR=$((MAJOR + 1))
                      MINOR=0
                      PATCH=0
                      ;;
                    minor)
                      MINOR=$((MINOR + 1))
                      PATCH=0
                      ;;
                    patch)
                      PATCH=$((PATCH + 1))
                      ;;
                  esac

                  NEW_VERSION="$MAJOR.$MINOR.$PATCH"
                  echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "New version: $NEW_VERSION (bump type: $BUMP_TYPE)"

            - name: Update package.json version
              run: |
                  NEW_VERSION="${{ steps.new-version.outputs.NEW_VERSION }}"
                  npm version $NEW_VERSION --no-git-tag-version
                  echo "Updated package.json to version $NEW_VERSION"

            - name: Update CHANGELOG.md
              run: |
                  NEW_VERSION="${{ steps.new-version.outputs.NEW_VERSION }}"
                  DATE=$(date +%Y-%m-%d)

                  # Create new changelog entry
                  TEMP_FILE=$(mktemp)

                  echo "# Changelog" > $TEMP_FILE
                  echo "" >> $TEMP_FILE
                  echo "All notable changes to Work Launcher will be documented in this file." >> $TEMP_FILE
                  echo "" >> $TEMP_FILE
                  echo "## [$NEW_VERSION] - $DATE" >> $TEMP_FILE
                  echo "" >> $TEMP_FILE
                  echo "### Changed" >> $TEMP_FILE
                  echo "- Automated release" >> $TEMP_FILE
                  echo "" >> $TEMP_FILE

                  # Append existing changelog (skip the header lines)
                  tail -n +6 CHANGELOG.md >> $TEMP_FILE

                  mv $TEMP_FILE CHANGELOG.md
                  echo "Updated CHANGELOG.md with version $NEW_VERSION"

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GH_TOKEN }}
                  commit-message: "chore: bump version to ${{ steps.new-version.outputs.NEW_VERSION }}"
                  title: "ðŸš€ Release v${{ steps.new-version.outputs.NEW_VERSION }}"
                  body: |
                      ## Automated Release PR

                      This PR bumps the version from `${{ steps.current-version.outputs.CURRENT_VERSION }}` to `${{ steps.new-version.outputs.NEW_VERSION }}`.

                      **Bump type:** `${{ github.event.inputs.bump_type }}`

                      ### Changes
                      - Updated `package.json` version
                      - Updated `CHANGELOG.md`

                      ### What happens next?
                      When this PR is merged to `main`, run the **"Publish Release"** workflow to:
                      1. Build the Windows installers (NSIS + MSI)
                      2. Create a GitHub Release with tag `v${{ steps.new-version.outputs.NEW_VERSION }}`
                      3. Upload the installers to the release

                      ---
                      *This PR was automatically created by the release workflow.*
                  branch: release/v${{ steps.new-version.outputs.NEW_VERSION }}
                  delete-branch: true
                  labels: |
                      release
                      automated
